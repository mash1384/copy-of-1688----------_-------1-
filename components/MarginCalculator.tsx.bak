import * as React from 'react';
import { useState, useMemo } from 'react';
import { Product, SalesChannel, ProductOption } from '../types';
import Card from './ui/Card';
import { CNY_TO_KRW_RATE } from '../constants';

interface MarginCalculatorProps {
  products: Product[];
  onUpdateProductOption: (productId: string, optionId: string, updates: Partial<ProductOption>) => void;
}

interface CalculationData {
  // ë§¤ì… ê´€ë ¨
  baseCostCny: number;
  quantity: number;
  shippingCostKrw: number;
  customsFeeKrw: number;
  otherFeeKrw: number;
  
  // íŒë§¤ ê´€ë ¨
  channel: SalesChannel;
  channelFeePercentage: number;
  packagingCostKrw: number;
  domesticShippingKrw: number;
  
  // ëª©í‘œ ì„¤ì •
  targetMarginRate: number;
  targetProfitRate: number;
  
  // ê³„ì‚° ëª¨ë“œ
  calculationMode: 'margin' | 'profit' | 'price';
  customSalePrice: number;
}

const MarginCalculator: React.FC<MarginCalculatorProps> = ({ products, onUpdateProductOption }) => {
  const [selectedProductId, setSelectedProductId] = useState<string>('');
  const [selectedOptionId, setSelectedOptionId] = useState<string>('');
  const [data, setData] = useState<CalculationData>({
    baseCostCny: 0,
    quantity: 1,
    shippingCostKrw: 0,
    customsFeeKrw: 0,
    otherFeeKrw: 0,
    channel: SalesChannel.SMART_STORE,
    channelFeePercentage: 5.5,
    packagingCostKrw: 500,
    domesticShippingKrw: 3000,
    targetMarginRate: 50,
    targetProfitRate: 30,
    calculationMode: 'margin',
    customSalePrice: 0
  });

  // ì„ íƒëœ ìƒí’ˆ ì •ë³´
  const selectedProduct = products.find(p => p.id === selectedProductId);
  const selectedOption = selectedProduct?.options.find(o => o.id === selectedOptionId);

  // ìƒí’ˆ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì›ê°€ ì •ë³´ ì—…ë°ì´íŠ¸
  const handleProductSelect = (productId: string) => {
    setSelectedProductId(productId);
    setSelectedOptionId('');
    const product = products.find(p => p.id === productId);
    if (product) {
      setData(prev => ({ ...prev, baseCostCny: product.baseCostCny }));
    } else {
      // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
      setData(prev => ({ ...prev, baseCostCny: prev.baseCostCny }));
    }
  };

  const handleOptionSelect = (optionId: string) => {
    setSelectedOptionId(optionId);
    const option = selectedProduct?.options.find(o => o.id === optionId);
    if (option) {
      // ì„ íƒëœ ì˜µì…˜ì˜ ì‹¤ì œ ì›ê°€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—­ì‚°í•˜ì—¬ ë§¤ì…ê°€ ì¶”ì •
      const estimatedBaseCost = option.costOfGoods / CNY_TO_KRW_RATE;
      setData(prev => ({ ...prev, baseCostCny: estimatedBaseCost }));
    }
  };

  // ìƒí’ˆ íŒë§¤ê°€ ì ìš© ê¸°ëŠ¥
  const applyToProduct = () => {
    if (!selectedProduct || !selectedOption) {
      alert('ìƒí’ˆê³¼ ì˜µì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (calculations.recommendedPrice <= 0) {
      alert('ìœ íš¨í•œ íŒë§¤ê°€ê°€ ê³„ì‚°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    const recommendedPrice = Math.round(calculations.recommendedPrice);
    const confirmMessage = `${selectedProduct.name} - ${selectedOption.name}ì— ê¶Œì¥ íŒë§¤ê°€ â‚©${recommendedPrice.toLocaleString()}ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì •ë³´ëŠ” ìƒí’ˆ ê´€ë¦¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    
    if (window.confirm(confirmMessage)) {
      // ì‹¤ì œë¡œ ìƒí’ˆ ì˜µì…˜ì— ê¶Œì¥ íŒë§¤ê°€ ì €ì¥
      onUpdateProductOption(selectedProduct.id, selectedOption.id, {
        recommendedPrice: recommendedPrice
      });
      
      alert(`âœ… íŒë§¤ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìƒí’ˆ: ${selectedProduct.name}\nì˜µì…˜: ${selectedOption.name}\nê¶Œì¥ íŒë§¤ê°€: â‚©${recommendedPrice.toLocaleString()}\n\nğŸ’¡ ìƒí’ˆ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    }
  };

  const calculations = useMemo(() => {
    // 1. ê°œë‹¹ ì‹¤ì œ ì›ê°€ ê³„ì‚°
    const baseCostKrw = data.baseCostCny * CNY_TO_KRW_RATE;
    const totalPurchaseCost = (baseCostKrw * data.quantity) + data.shippingCostKrw + data.customsFeeKrw + data.otherFeeKrw;
    const actualCostPerItem = totalPurchaseCost / data.quantity;
    
    // 2. íŒë§¤ ì‹œ ì¶”ê°€ ë¹„ìš© (ê°œë‹¹)
    const packagingCost = data.packagingCostKrw;
    const shippingCost = data.domesticShippingKrw;
    
    // 3. ê³„ì‚° ëª¨ë“œë³„ ê²°ê³¼
    let recommendedPrice = 0;
    let actualMarginRate = 0;
    let actualProfitRate = 0;
    let netProfit = 0;
    
    if (data.calculationMode === 'margin') {
      // ë§ˆì§„ìœ¨ ê¸°ì¤€ìœ¼ë¡œ íŒë§¤ê°€ ê³„ì‚°
      // íŒë§¤ê°€ = ì›ê°€ / (1 - ë§ˆì§„ìœ¨/100)
      const totalCostPerItem = actualCostPerItem + packagingCost + shippingCost;
      recommendedPrice = totalCostPerItem / (1 - data.targetMarginRate / 100);
      
      // ì±„ë„ ìˆ˜ìˆ˜ë£Œ ê³ ë ¤í•œ ì‹¤ì œ íŒë§¤ê°€
      recommendedPrice = recommendedPrice / (1 - data.channelFeePercentage / 100);
      
    } else if (data.calculationMode === 'profit') {
      // ìˆœì´ìµë¥  ê¸°ì¤€ìœ¼ë¡œ íŒë§¤ê°€ ê³„ì‚°
      const totalCostPerItem = actualCostPerItem + packagingCost + shippingCost;
      recommendedPrice = totalCostPerItem * (1 + data.targetProfitRate / 100);
      
      // ì±„ë„ ìˆ˜ìˆ˜ë£Œ ê³ ë ¤í•œ ì‹¤ì œ íŒë§¤ê°€
      recommendedPrice = recommendedPrice / (1 - data.channelFeePercentage / 100);
      
    } else {
      // ì‚¬ìš©ì ì§€ì • íŒë§¤ê°€
      recommendedPrice = data.customSalePrice;
    }
    
    // 4. ì‹¤ì œ ìˆ˜ìµì„± ê³„ì‚°
    const grossRevenue = recommendedPrice;
    const channelFee = grossRevenue * (data.channelFeePercentage / 100);
    const netRevenue = grossRevenue - channelFee;
    const totalCosts = actualCostPerItem + packagingCost + shippingCost;
    netProfit = netRevenue - totalCosts;
    
    actualMarginRate = grossRevenue > 0 ? ((grossRevenue - totalCosts) / grossRevenue) * 100 : 0;
    actualProfitRate = totalCosts > 0 ? (netProfit / totalCosts) * 100 : 0;
    
    // 5. íˆ¬ì íšŒìˆ˜ ë¶„ì„
    const totalInvestment = totalPurchaseCost; // ì´ íˆ¬ìê¸ˆ (ë§¤ì…ë¹„ìš© + ì¶”ê°€ë¹„ìš©)
    const breakEvenQuantity = netRevenue > 0 ? totalInvestment / netRevenue : 0; // íˆ¬ì íšŒìˆ˜ í•„ìš” íŒë§¤ëŸ‰ (ì‹¤ì œ ìˆ˜ì·¨ì•¡ ê¸°ì¤€)
    
    // 6. ì „ì²´ ìˆ˜ëŸ‰ íŒë§¤ ì‹œ ìˆ˜ìµ ë¶„ì„
    const totalRevenue = recommendedPrice * data.quantity; // ì´ ë§¤ì¶œ
    const totalChannelFee = totalRevenue * (data.channelFeePercentage / 100); // ì´ ì±„ë„ ìˆ˜ìˆ˜ë£Œ
    const totalSellingCosts = (packagingCost + shippingCost) * data.quantity; // ì´ íŒë§¤ ë¹„ìš© (í¬ì¥ë¹„ + ë°°ì†¡ë¹„)
    const totalNetProfit = totalRevenue - totalChannelFee - totalPurchaseCost - totalSellingCosts; // ìˆœ ì´ ìˆ˜ìµ
    const roi = totalInvestment > 0 ? (totalNetProfit / totalInvestment) * 100 : 0; // íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥  (ROI)
    
    return {
      baseCostKrw,
      actualCostPerItem,
      totalCostPerItem: actualCostPerItem + packagingCost + shippingCost,
      recommendedPrice,
      grossRevenue,
      channelFee,
      netRevenue,
      netProfit,
      actualMarginRate,
      actualProfitRate,
      totalCosts,
      // íˆ¬ì íšŒìˆ˜ ë¶„ì„
      totalInvestment,
      breakEvenQuantity,
      // ì „ì²´ íŒë§¤ ì‹œ ìˆ˜ìµ ë¶„ì„
      totalRevenue,
      totalChannelFee,
      totalSellingCosts,
      totalNetProfit,
      roi
    };
  }, [data]);

  const handleInputChange = (field: keyof CalculationData, value: any) => {
    setData(prev => ({ ...prev, [field]: value }));
  };

  const handleChannelChange = (channel: SalesChannel) => {
    let feePercentage = 5.5; // ê¸°ë³¸ê°’
    switch (channel) {
      case SalesChannel.SMART_STORE:
        feePercentage = 5.5;
        break;
      case SalesChannel.COUPANG:
        feePercentage = 10.8;
        break;
      case SalesChannel.OWN_MALL:
        feePercentage = 2.0;
        break;
      default:
        feePercentage = 5.0;
    }
    
    setData(prev => ({ 
      ...prev, 
      channel, 
      channelFeePercentage: feePercentage 
    }));
  };

  const formatCurrency = (value: number) => `â‚©${Math.round(value).toLocaleString()}`;

  return (
    <div className="space-y-6">
      {/* í—¤ë” */}
      <div className="text-center mb-4">
        <h1 className="text-2xl font-bold text-gray-800 mb-1">ğŸ§® ë§ˆì§„ ê³„ì‚°ê¸°</h1>
        <p className="text-sm text-gray-600">ë§¤ì…ë¶€í„° íŒë§¤ê¹Œì§€ ëª¨ë“  ë¹„ìš©ì„ ê³ ë ¤í•œ ì •í™•í•œ ìˆ˜ìµì„± ë¶„ì„</p>
      </div>

      {/* í•µì‹¬ ê²°ê³¼ ìš”ì•½ - ìƒë‹¨ì— ë°°ì¹˜ */}
      {(data.baseCostCny > 0 || data.customSalePrice > 0) && (
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 mb-4">
          <h2 className="text-lg font-bold text-gray-800 mb-3 text-center">ğŸ“Š ê³„ì‚° ê²°ê³¼ ìš”ì•½</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div className="text-center">
              <div className="text-xs text-gray-600 mb-1">ê¶Œì¥ íŒë§¤ê°€</div>
              <div className="text-lg font-bold text-blue-600">{formatCurrency(calculations.recommendedPrice)}</div>
            </div>
            <div className="text-center">
              <div className="text-xs text-gray-600 mb-1">ê°œë‹¹ ìˆœì´ìµ</div>
              <div className={`text-lg font-bold ${calculations.netProfit > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatCurrency(calculations.netProfit)}
              </div>
            </div>
            <div className="text-center">
              <div className="text-xs text-gray-600 mb-1">ë§ˆì§„ìœ¨</div>
              <div className="text-lg font-bold text-purple-600">{calculations.actualMarginRate.toFixed(1)}%</div>
            </div>
            <div className="text-center">
              <div className="text-xs text-gray-600 mb-1">íˆ¬ì íšŒìˆ˜ëŸ‰</div>
              <div className="text-lg font-bold text-orange-600">
                {calculations.breakEvenQuantity > 0 ? `${Math.ceil(calculations.breakEvenQuantity)}ê°œ` : '-'}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ë²¤í†  ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */}
      <div className="grid grid-cols-12 gap-3 auto-rows-min">
        
        {/* ìƒí’ˆ ì„ íƒ - ë„“ì€ ì¹´ë“œ */}
        <Card className="col-span-6 p-3">
            <h3 className="text-sm font-semibold text-gray-800 mb-2 flex items-center">
              ğŸ¯ ìƒí’ˆ ì„ íƒ (ì„ íƒì‚¬í•­)
            </h3>
            <div className="space-y-3">
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">ìƒí’ˆ</label>
                <select
                  value={selectedProductId}
                  onChange={(e) => handleProductSelect(e.target.value)}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">ì§ì ‘ ì…ë ¥ ëª¨ë“œ</option>
                  {products.map(product => (
                    <option key={product.id} value={product.id}>{product.name}</option>
                  ))}
                </select>
              </div>
              
              {selectedProductId && (
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ì˜µì…˜</label>
                  <select
                    value={selectedOptionId}
                    onChange={(e) => handleOptionSelect(e.target.value)}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">ì˜µì…˜ ì„ íƒ</option>
                    {selectedProduct?.options.map(option => (
                      <option key={option.id} value={option.id}>
                        {option.name} (ì¬ê³ : {option.stock}ê°œ, ì›ê°€: â‚©{Math.round(option.costOfGoods).toLocaleString()})
                      </option>
                    ))}
                  </select>
                </div>
              )}
              
              {selectedProduct && selectedOption && calculations.recommendedPrice > 0 && (
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-blue-800">ì„ íƒëœ ìƒí’ˆ</span>
                    <button
                      onClick={applyToProduct}
                      className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                    >
                      íŒë§¤ê°€ ë©”ëª¨
                    </button>
                  </div>
                  <div className="text-xs text-blue-700">
                    <div>{selectedProduct.name} - {selectedOption.name}</div>
                    <div>í˜„ì¬ ì›ê°€: â‚©{Math.round(selectedOption.costOfGoods).toLocaleString()}</div>
                    <div>ê¶Œì¥ íŒë§¤ê°€: â‚©{Math.round(calculations.recommendedPrice).toLocaleString()}</div>
                  </div>
                </div>
              )}
            </div>
          </Card>

          {/* ë§¤ì… ì •ë³´ */}
          <Card className="col-span-3 p-3">
            <h3 className="text-sm font-semibold text-gray-800 mb-2 flex items-center">
              ğŸ“¦ ë§¤ì… ì •ë³´
            </h3>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ë§¤ì…ê°€ (Â¥)</label>
                  <input
                    type="number"
                    value={data.baseCostCny}
                    onChange={(e) => handleInputChange('baseCostCny', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ëŸ‰</label>
                  <input
                    type="number"
                    value={data.quantity}
                    onChange={(e) => handleInputChange('quantity', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="1"
                    min="1"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-3 gap-2">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ë°°ì†¡ë¹„</label>
                  <input
                    type="number"
                    value={data.shippingCostKrw}
                    onChange={(e) => handleInputChange('shippingCostKrw', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê´€ì„¸</label>
                  <input
                    type="number"
                    value={data.customsFeeKrw}
                    onChange={(e) => handleInputChange('customsFeeKrw', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê¸°íƒ€</label>
                  <input
                    type="number"
                    value={data.otherFeeKrw}
                    onChange={(e) => handleInputChange('otherFeeKrw', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
              </div>
            </div>
          </Card>

          {/* íŒë§¤ ì •ë³´ */}
          <Card className="col-span-3 p-3">
            <h3 className="text-sm font-semibold text-gray-800 mb-2 flex items-center">
              ğŸ›’ íŒë§¤ ì •ë³´
            </h3>
            <div className="space-y-3">
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">íŒë§¤ ì±„ë„</label>
                <select
                  value={data.channel}
                  onChange={(e) => handleChannelChange(e.target.value as SalesChannel)}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value={SalesChannel.SMART_STORE}>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ (5.5%)</option>
                  <option value={SalesChannel.COUPANG}>ì¿ íŒ¡ (10.8%)</option>
                  <option value={SalesChannel.OWN_MALL}>ìì‚¬ëª° (2.0%)</option>
                  <option value={SalesChannel.OTHER}>ê¸°íƒ€</option>
                </select>
              </div>
              
              <div className="grid grid-cols-3 gap-2">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ìˆ˜ë£Œ(%)</label>
                  <input
                    type="number"
                    value={data.channelFeePercentage}
                    onChange={(e) => handleInputChange('channelFeePercentage', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="5.5"
                    step="0.1"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">í¬ì¥ë¹„</label>
                  <input
                    type="number"
                    value={data.packagingCostKrw}
                    onChange={(e) => handleInputChange('packagingCostKrw', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="500"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">êµ­ë‚´ë°°ì†¡</label>
                  <input
                    type="number"
                    value={data.domesticShippingKrw}
                    onChange={(e) => handleInputChange('domesticShippingKrw', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="3000"
                  />
                </div>
              </div>
            </div>
          </Card>

          {/* ê³„ì‚° ëª¨ë“œ */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              ğŸ¯ ê³„ì‚° ëª¨ë“œ
            </h3>
            <div className="space-y-3">
              <div className="grid grid-cols-1 gap-2">
                <label className="flex items-center text-sm">
                  <input
                    type="radio"
                    name="calculationMode"
                    value="margin"
                    checked={data.calculationMode === 'margin'}
                    onChange={(e) => handleInputChange('calculationMode', e.target.value)}
                    className="mr-2"
                  />
                  ë§ˆì§„ìœ¨ ê¸°ì¤€
                </label>
                <label className="flex items-center text-sm">
                  <input
                    type="radio"
                    name="calculationMode"
                    value="profit"
                    checked={data.calculationMode === 'profit'}
                    onChange={(e) => handleInputChange('calculationMode', e.target.value)}
                    className="mr-2"
                  />
                  ìˆœì´ìµë¥  ê¸°ì¤€
                </label>
                <label className="flex items-center text-sm">
                  <input
                    type="radio"
                    name="calculationMode"
                    value="price"
                    checked={data.calculationMode === 'price'}
                    onChange={(e) => handleInputChange('calculationMode', e.target.value)}
                    className="mr-2"
                  />
                  íŒë§¤ê°€ ì§ì ‘ ì…ë ¥
                </label>
              </div>
              
              {data.calculationMode === 'margin' && (
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ëª©í‘œ ë§ˆì§„ìœ¨ (%)</label>
                  <input
                    type="number"
                    value={data.targetMarginRate}
                    onChange={(e) => handleInputChange('targetMarginRate', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="50"
                    step="0.1"
                  />
                </div>
              )}
              
              {data.calculationMode === 'profit' && (
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ëª©í‘œ ìˆœì´ìµë¥  (%)</label>
                  <input
                    type="number"
                    value={data.targetProfitRate}
                    onChange={(e) => handleInputChange('targetProfitRate', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="30"
                    step="0.1"
                  />
                </div>
              )}
              
              {data.calculationMode === 'price' && (
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">íŒë§¤ê°€ (â‚©)</label>
                  <input
                    type="number"
                    value={data.customSalePrice}
                    onChange={(e) => handleInputChange('customSalePrice', Number(e.target.value))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
              )}
            </div>
          </Card>
        </div>

        {/* ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ */}
        <div className="space-y-4">
          {/* ì›ê°€ & íŒë§¤ê°€ í†µí•© */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3">ğŸ’° ì›ê°€ & íŒë§¤ê°€</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">ê¸°ë³¸ ë§¤ì…ê°€</span>
                <span className="font-medium">{formatCurrency(calculations.baseCostKrw)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ì‹¤ì œ ê°œë‹¹ ì›ê°€</span>
                <span className="font-medium text-orange-600">{formatCurrency(calculations.actualCostPerItem)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">íŒë§¤ ë¶€ëŒ€ë¹„ìš©</span>
                <span className="font-medium">{formatCurrency(data.packagingCostKrw + data.domesticShippingKrw)}</span>
              </div>
              <div className="flex justify-between border-t pt-2 font-semibold">
                <span className="text-gray-800">ì´ ë¹„ìš© (ê°œë‹¹)</span>
                <span className="text-red-600">{formatCurrency(calculations.totalCostPerItem)}</span>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg mt-3">
                <div className="flex justify-between items-center">
                  <span className="text-blue-800 font-semibold">ê¶Œì¥ íŒë§¤ê°€</span>
                  <span className="text-xl font-bold text-blue-600">{formatCurrency(calculations.recommendedPrice)}</span>
                </div>
              </div>
            </div>
          </Card>

          {/* ìˆ˜ìµì„± ì§€í‘œ */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3">ğŸ“ˆ ìˆ˜ìµì„± ì§€í‘œ</h3>
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-blue-50 p-3 rounded-lg text-center">
                <div className="text-xs text-blue-600 font-medium">ë§ˆì§„ìœ¨</div>
                <div className="text-xl font-bold text-blue-800">{calculations.actualMarginRate.toFixed(1)}%</div>
              </div>
              <div className="bg-green-50 p-3 rounded-lg text-center">
                <div className="text-xs text-green-600 font-medium">ìˆœì´ìµë¥ </div>
                <div className="text-xl font-bold text-green-800">{calculations.actualProfitRate.toFixed(1)}%</div>
              </div>
            </div>
            <div className="mt-3 space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">ì±„ë„ ìˆ˜ìˆ˜ë£Œ</span>
                <span className="text-red-500">-{formatCurrency(calculations.channelFee)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ì‹¤ì œ ìˆ˜ì·¨ì•¡</span>
                <span className="font-medium">{formatCurrency(calculations.netRevenue)}</span>
              </div>
              <div className="flex justify-between border-t pt-2 font-semibold">
                <span className="text-gray-800">ê°œë‹¹ ìˆœì´ìµ</span>
                <span className={calculations.netProfit > 0 ? 'text-green-600' : 'text-red-600'}>
                  {formatCurrency(calculations.netProfit)}
                </span>
              </div>
            </div>
          </Card>

          {/* ì†ìµë¶„ê¸°ì  */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3">âš–ï¸ ì†ìµë¶„ê¸°ì </h3>
            <div className="bg-orange-50 p-3 rounded-lg">
              <div className="text-center">
                <div className="text-xs text-orange-600 font-medium">ìµœì†Œ íŒë§¤ê°€</div>
                <div className="text-lg font-bold text-orange-800">
                  {formatCurrency(calculations.totalCostPerItem / (1 - data.channelFeePercentage / 100))}
                </div>
              </div>
            </div>
            <div className="text-xs text-gray-500 mt-2 text-center">
              ì±„ë„ ìˆ˜ìˆ˜ë£Œë¥¼ ê³ ë ¤í•œ ìµœì†Œ íŒë§¤ê°€
            </div>
          </Card>
        </div>

        {/* íˆ¬ì & ìˆ˜ìµ ë¶„ì„ */}
        <div className="space-y-4">
          {/* íˆ¬ì íšŒìˆ˜ ë¶„ì„ */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3">ğŸ’¸ íˆ¬ì íšŒìˆ˜ ë¶„ì„</h3>
            <div className="space-y-2 text-sm">
              <div className="bg-red-50 p-3 rounded-lg">
                <div className="text-center">
                  <div className="text-xs text-red-600 font-medium">ì´ íˆ¬ìê¸ˆ</div>
                  <div className="text-lg font-bold text-red-800">{formatCurrency(calculations.totalInvestment)}</div>
                </div>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ê°œë‹¹ ìˆ˜ì·¨ì•¡</span>
                <span className="font-medium text-green-600">{formatCurrency(calculations.netRevenue)}</span>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg">
                <div className="text-center">
                  <div className="text-xs text-blue-600 font-medium">íšŒìˆ˜ í•„ìš” íŒë§¤ëŸ‰</div>
                  <div className="text-lg font-bold text-blue-800">
                    {calculations.breakEvenQuantity > 0 ? `${Math.ceil(calculations.breakEvenQuantity)}ê°œ` : 'íšŒìˆ˜ ë¶ˆê°€'}
                  </div>
                </div>
              </div>
            </div>
            
            {calculations.breakEvenQuantity > 0 && calculations.breakEvenQuantity <= data.quantity && (
              <div className="text-xs text-green-600 bg-green-50 p-2 rounded mt-3">
                âœ… ë§¤ì… ìˆ˜ëŸ‰ ë‚´ì—ì„œ íˆ¬ìê¸ˆ íšŒìˆ˜ ê°€ëŠ¥
              </div>
            )}
            {calculations.breakEvenQuantity > data.quantity && calculations.breakEvenQuantity > 0 && (
              <div className="text-xs text-orange-600 bg-orange-50 p-2 rounded mt-3">
                âš ï¸ {Math.ceil(calculations.breakEvenQuantity - data.quantity)}ê°œ ì¶”ê°€ íŒë§¤ í•„ìš”
              </div>
            )}
            {calculations.breakEvenQuantity <= 0 && (
              <div className="text-xs text-red-600 bg-red-50 p-2 rounded mt-3">
                âŒ í˜„ì¬ íŒë§¤ê°€ë¡œëŠ” íˆ¬ìê¸ˆ íšŒìˆ˜ ë¶ˆê°€ëŠ¥
              </div>
            )}
          </Card>

          {/* ì „ì²´ íŒë§¤ ì‹œ ìˆ˜ìµ */}
          <Card>
            <h3 className="text-lg font-semibold text-gray-800 mb-3">ğŸ¯ ì „ì²´ íŒë§¤ ì‹œ ìˆ˜ìµ</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">ë§¤ì… ìˆ˜ëŸ‰</span>
                <span className="font-medium">{data.quantity}ê°œ</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ì´ ë§¤ì¶œ</span>
                <span className="font-medium text-blue-600">{formatCurrency(calculations.totalRevenue)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ì´ ìˆ˜ìˆ˜ë£Œ</span>
                <span className="text-red-500">-{formatCurrency(calculations.totalChannelFee)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ì´ íŒë§¤ë¹„ìš©</span>
                <span className="text-red-500">-{formatCurrency(calculations.totalSellingCosts)}</span>
              </div>
              <div className="border-t pt-2">
                <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg">
                  <div className="text-center">
                    <div className="text-xs text-green-600 font-medium">ìˆœ ì´ ìˆ˜ìµ</div>
                    <div className={`text-xl font-bold ${calculations.totalNetProfit > 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {formatCurrency(calculations.totalNetProfit)}
                    </div>
                  </div>
                </div>
              </div>
              <div className="bg-purple-50 p-3 rounded-lg">
                <div className="text-center">
                  <div className="text-xs text-purple-600 font-medium">íˆ¬ì ìˆ˜ìµë¥  (ROI)</div>
                  <div className={`text-lg font-bold ${calculations.roi > 0 ? 'text-purple-600' : 'text-red-600'}`}>
                    {calculations.roi.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
            
            {calculations.totalNetProfit > 0 ? (
              <div className="mt-3 p-3 bg-green-50 rounded-lg">
                <div className="text-xs text-green-800 text-center">
                  <strong>ğŸ’¡ ì „ì²´ {data.quantity}ê°œ íŒë§¤ ì‹œ</strong><br/>
                  <strong>{formatCurrency(calculations.totalNetProfit)}</strong> ìˆœì´ìµ ì˜ˆìƒ
                </div>
              </div>
            ) : (
              <div className="mt-3 p-3 bg-red-50 rounded-lg">
                <div className="text-xs text-red-800 text-center">
                  <strong>âš ï¸ ì†ì‹¤ ì˜ˆìƒ</strong><br/>
                  íŒë§¤ê°€ ì¡°ì • í•„ìš”
                </div>
              </div>
            )}
          </Card>
        </div>
      </div>
    </div>
  );
};

export default MarginCalculator;